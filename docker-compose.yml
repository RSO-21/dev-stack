services:
  keycloak-db:
    image: postgres:16
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    volumes:
      - keycloak_postgres:/var/lib/postgresql/data
    networks:
      - fri-net

  keycloak:
    image: quay.io/keycloak/keycloak:23.0.7
    command:
      - start-dev
      - --import-realm
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
    depends_on:
      - keycloak-db
    volumes:
      - keycloak_data:/opt/keycloak/data
      - ../auth-service/keycloak-local/fri-food-realm.json:/opt/keycloak/data/import/fri-food-realm.json:ro
    ports:
      - "8080:8080"
    networks:
      - fri-net

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - fri-net
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  api-gateway:
    build: ../api-gateway
    ports:
      - "9000:9000"
    environment:
      - ORDER_SERVICE_URL=http://order-service:8000
      - PAYMENT_SERVICE_URL=http://payment-service:8000
      - PARTNER_SERVICE_URL=http://partner-service:8000
      - OFFER_SERVICE_URL=http://offer-service:8000
      - NOTIFICATION_SERVICE_URL=http://notification-service:8000
      - USER_SERVICE_URL=http://user-service:8000
    depends_on:
      order-service:
        condition: service_started
      payment-service:
        condition: service_started
    networks:
      - fri-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  auth-service:
    build:
      context: ../auth-service
      dockerfile: Dockerfile
    env_file:
      - ../auth-service/.env
    environment:
      KEYCLOAK_BASE_URL: http://keycloak:8080
      FLASK_PORT: "8000"
    depends_on:
      - keycloak
    ports:
      - "8005:8000"
    networks:
      - fri-net

  partner-service:
    build:
      context: ../partner-service
      dockerfile: Dockerfile
    env_file:
      - ../partner-service/.env
    ports:
      - "8000:8000"
      - "50051:50051"
    networks:
      - fri-net

  offer-service:
    build:
      context: ../offer-service
      dockerfile: Dockerfile
    env_file:
      - ../offer-service/.env
    depends_on:
      - partner-service
    environment:
      PARTNER_GRPC_HOST: partner-service
      PARTNER_GRPC_PORT: "50051"
    ports:
      - "8001:8000"
    networks:
      - fri-net

  order-service:
    build:
      context: ../order-service
      dockerfile: Dockerfile
    env_file:
      - ../order-service/.env
    environment:
      - PAYMENT_GRPC_HOST=payment-grpc
      - PAYMENT_GRPC_PORT=50051
      - RABBITMQ_HOST=rabbitmq
    ports:
      - "8002:8000"
      - "50053:50051"
    depends_on:
      - rabbitmq
      - payment-grpc
    networks:
      - fri-net

  order-consumer:
    build:
      context: ../order-service
    command: python -m app.rabbitmq_consumer
    restart: always
    environment:
      - RABBITMQ_HOST=rabbitmq
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - fri-net

  user-consumer:
    build:
      context: ../user-service
    command: python -m app.rabbitmq_consumer
    restart: always
    environment:
      - RABBITMQ_HOST=rabbitmq
    env_file:
      - ../user-service/.env
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - fri-net

  payment-service:
    build:
      context: ../payment-service
      dockerfile: Dockerfile
    env_file:
      - ../payment-service/.env
    environment:
      - PAYMENT_GRPC_HOST=payment-grpc
      - PAYMENT_GRPC_PORT=50051
    ports:
      - "8003:8000"
    networks:
      - fri-net

  payment-grpc:
    build:
      context: ../payment-service
    command: python -m app.grpc_server
    environment:
      - RABBITMQ_HOST=rabbitmq
      - PAYMENT_GRPC_HOST=payment-grpc
      - PAYMENT_GRPC_PORT=50051
    ports:
      - "50052:50051"
    networks:
      - fri-net

  user-service:
    build:
      context: ../user-service
      dockerfile: Dockerfile
    env_file:
      - ../user-service/.env
    environment:
      - ORDERS_GRPC_HOST=order-service
      - ORDERS_GRPC_PORT=50051
    ports:
      - "8004:8000"
    networks:
      - fri-net
  
  notification-service:
    build:
      context: ../notification-service
      dockerfile: Dockerfile
    env_file:
      - ../notification-service/.env
    depends_on:
      rabbitmq:
        condition: service_healthy
    ports:
      - "8006:8000"
    networks:
      - fri-net

  notification-consumer:
    build:
      context: ../notification-service
      dockerfile: Dockerfile
    command: python -m app.rabbitmq_consumer
    restart: always
    env_file:
      - ../notification-service/.env
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - fri-net


  frontend:
    build:
      context: ../frifood-frontend
      dockerfile: Dockerfile
    ports:
      - "4200:80"
    depends_on:
      - auth-service
    networks:
      - fri-net

  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ../monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
    ports:
      - "9090:9090"
    networks:
      - fri-net

  grafana:
    image: grafana/grafana:latest
    depends_on:
      - prometheus
    ports:
      - "3000:3000"
    volumes:
      - ../monitoring/dashboards:/var/lib/grafana/dashboards
      - ../monitoring/provisioning:/etc/grafana/provisioning
    networks:
      - fri-net

networks:
  fri-net:
    name: fri-net
    external: true

volumes:
  keycloak_data:
  keycloak_postgres:
  frontend_node_modules:
